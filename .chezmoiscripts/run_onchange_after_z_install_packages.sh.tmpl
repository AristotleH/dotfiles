#!/bin/sh

internet_available() {
    if command -v curl >/dev/null 2>&1; then
        curl -fsSLI --connect-timeout 2 --max-time 5 https://github.com >/dev/null 2>&1
        return $?
    fi
    if command -v wget >/dev/null 2>&1; then
        wget -q --spider --timeout=5 https://github.com >/dev/null 2>&1
        return $?
    fi
    return 1
}

install_brew() {
    if ! internet_available; then
        echo "No internet connection detected. Skipping Homebrew install."
        return 0
    fi
    command -v brew >/dev/null 2>&1 && return 0
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
}

install_brew_packages() {
    {{ if eq .chezmoi.os "darwin" }}
    if [ -f ~/.config/Brewfile_darwin ]; then
        echo "Installing packages from Brewfile..."
        brew bundle --no-upgrade --file=~/.config/Brewfile_darwin
    fi
    {{ else }}
    : # No-op on non-Darwin systems
    {{ end }}
}

install_linux_packages() {
    {{ if eq .chezmoi.os "linux" }}
    if ! internet_available; then
        echo "No internet connection detected. Skipping Linux package installation."
        return 0
    fi
    # Detect package manager and use generated package list
    if command -v apt-get >/dev/null 2>&1; then
        # Debian/Ubuntu/Raspberry Pi
        if [ -f ~/.config/packages-apt.txt ]; then
            echo "Installing APT packages..."
            packages=$(grep -v '^#' ~/.config/packages-apt.txt | grep -v '^$' | tr '\n' ' ')
            sudo apt-get update -qq
            # shellcheck disable=SC2086
            sudo apt-get install --no-upgrade -y $packages
            sudo apt-get autoremove -y
            sudo apt-get autoclean
        fi
    elif command -v pacman >/dev/null 2>&1; then
        # Arch Linux
        if [ -f ~/.config/packages-pacman.txt ]; then
            echo "Installing Pacman packages..."
            packages=$(grep -v '^#' ~/.config/packages-pacman.txt | grep -v '^$' | tr '\n' ' ')
            # shellcheck disable=SC2086
            sudo pacman -S --needed --noconfirm $packages
        fi
    elif command -v dnf >/dev/null 2>&1; then
        # Fedora/RHEL
        if [ -f ~/.config/packages-dnf.txt ]; then
            echo "Installing DNF packages..."
            packages=$(grep -v '^#' ~/.config/packages-dnf.txt | grep -v '^$' | tr '\n' ' ')
            # shellcheck disable=SC2086
            sudo dnf install -y $packages
        fi
    elif [ -f /mingw64/bin/pacman ]; then
        # MSYS2 (Windows)
        if [ -f ~/.config/packages-msys2.txt ]; then
            echo "Installing MSYS2 packages..."
            packages=$(grep -v '^#' ~/.config/packages-msys2.txt | grep -v '^$' | tr '\n' ' ')
            # shellcheck disable=SC2086
            pacman -S --needed --noconfirm $packages
        fi
    fi
    {{ else }}
    : # No-op on non-Linux systems
    {{ end }}
}

main() {
    {{ if .packages.runInstalls }}
    echo "üöÄ Installing packages..."
    if ! internet_available; then
        echo "‚è≠Ô∏è  No internet connection detected; skipping package auto-install."
        exit 0
    fi

    # macOS
    {{     if eq .chezmoi.os "darwin" }}
    echo "üì¶ macOS detected - installing via Homebrew"

    # Install Xcode Command Line Tools (silently fail if already installed)
    xcode-select --install 2>/dev/null || true

    # Install Homebrew if not present
    install_brew

    # Set up Homebrew environment
    if [ -f /opt/homebrew/bin/brew ]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [ -f /usr/local/bin/brew ]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi

    # Install packages from Brewfile
    install_brew_packages

    # Linux
    {{     else if eq .chezmoi.os "linux" }}
    echo "üì¶ Linux detected - installing via native package manager"
    install_linux_packages
    {{     end }}

    echo "‚úÖ Package installation complete!"
    {{ else }}
    echo "‚è≠Ô∏è  Package auto-install disabled (set packages.runInstalls=true to enable)"
    {{ end }}
}

main
