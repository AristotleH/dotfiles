#!/bin/sh
# Generate shell config files from shell.yaml after chezmoi apply.
# Supports per-machine customization via ~/.config/shell.d/*.yaml

set -e

# Find the best python3 available (prefer Homebrew over system)
PYTHON3=""
for candidate in /opt/homebrew/bin/python3 /usr/local/bin/python3 python3; do
    if command -v "$candidate" >/dev/null 2>&1; then
        PYTHON3="$candidate"
        break
    fi
done

if [ -z "$PYTHON3" ]; then
    echo "shell-gen: python3 not found, skipping"
    exit 0
fi

# Skip if pyyaml is not available
if ! "$PYTHON3" -c "import yaml" 2>/dev/null; then
    echo "shell-gen: pyyaml not installed, skipping"
    exit 0
fi

CHEZMOI_SRC="{{ .chezmoi.sourceDir }}"
GENERATOR="${CHEZMOI_SRC}/.pkgmgmt/generate_shell.py"

if [ ! -f "$GENERATOR" ]; then
    echo "shell-gen: generator not found at $GENERATOR, skipping"
    exit 0
fi

EXTRA_DIR="{{ .chezmoi.homeDir }}/.config/shell.d"

"$PYTHON3" "$GENERATOR" --target "{{ .chezmoi.homeDir }}/.config" "$CHEZMOI_SRC/.pkgmgmt/shell.yaml" "$EXTRA_DIR"
