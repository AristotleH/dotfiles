#!/bin/sh
# Generate shell config files from shell.yaml after chezmoi apply.
# Supports per-machine customization via:
#   1. Extra manifest paths configured during chezmoi init (comma-separated)
#   2. ~/.config/shell.d/*.yaml directory (auto-discovered)

set -e

# Find the best python3 available (prefer Homebrew over system)
PYTHON3=""
for candidate in /opt/homebrew/bin/python3 /usr/local/bin/python3 python3; do
    if command -v "$candidate" >/dev/null 2>&1; then
        PYTHON3="$candidate"
        break
    fi
done

if [ -z "$PYTHON3" ]; then
    echo "shell-gen: python3 not found, skipping"
    exit 0
fi

# Skip if pyyaml is not available
if ! "$PYTHON3" -c "import yaml" 2>/dev/null; then
    echo "shell-gen: pyyaml not installed, skipping"
    exit 0
fi

CHEZMOI_SRC="{{ .chezmoi.sourceDir }}"
GENERATOR="${CHEZMOI_SRC}/.shellgen/generate_shell.py"

if [ ! -f "$GENERATOR" ]; then
    echo "shell-gen: generator not found at $GENERATOR, skipping"
    exit 0
fi

EXTRA_DIR="{{ .chezmoi.homeDir }}/.config/shell.d"

# Build source arguments: main manifest, then any extra manifests from config,
# then the shell.d directory. Merge order is left-to-right (last wins).
SOURCES="$CHEZMOI_SRC/.shellgen/shell.yaml"

EXTRA_MANIFESTS="{{ .shell.extraManifests }}"
if [ -n "$EXTRA_MANIFESTS" ]; then
    # Split comma-separated paths and add existing files
    OLD_IFS="$IFS"
    IFS=','
    for p in $EXTRA_MANIFESTS; do
        # Trim whitespace
        p="$(echo "$p" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
        if [ -n "$p" ] && [ -e "$p" ]; then
            SOURCES="$SOURCES $p"
        fi
    done
    IFS="$OLD_IFS"
fi

SOURCES="$SOURCES $EXTRA_DIR"

"$PYTHON3" "$GENERATOR" --target "{{ .chezmoi.homeDir }}/.config" $SOURCES
