name: Package Management Tests

on:
  push:
    paths:
      - '.pkgmgmt/**'
      - 'dot_config/Brewfile_darwin'
      - 'dot_config/packages-*.txt.tmpl'
      - '.chezmoiscripts/**'
  pull_request:
    paths:
      - '.pkgmgmt/**'
      - 'dot_config/Brewfile_darwin'
      - 'dot_config/packages-*.txt.tmpl'
      - '.chezmoiscripts/**'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Run unit tests
        run: python3 .pkgmgmt/tests/test_generator.py

      - name: Check generated files are in sync
        run: python3 .pkgmgmt/tests/test_sync.py

      - name: Validate zsh configuration
        run: python3 .pkgmgmt/tests/test_zsh.py

      - name: Run shell generator unit tests
        run: python3 .pkgmgmt/tests/test_shell_generator.py

      - name: Validate shell generator (temp dir)
        run: python3 .pkgmgmt/tests/test_shell_sync.py

      - name: Validate Brewfile syntax
        if: hashFiles('dot_config/Brewfile_darwin') != ''
        run: |
          # Just check it's valid YAML-ish (has proper quotes, etc)
          grep -E '^(brew|cask|mas|tap) "' dot_config/Brewfile_darwin > /dev/null || {
            echo "Brewfile syntax appears invalid"
            exit 1
          }
          echo "‚úì Brewfile syntax looks good"

  integration-test-debian:
    name: Integration Test (Debian)
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v5
        with:
          context: .pkgmgmt/test-environments
          file: .pkgmgmt/test-environments/Dockerfile.debian
          tags: chezmoi-test-debian:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Test chezmoi initialization
        run: |
          docker run --rm \
            -v "$PWD:/dotfiles-src:ro" \
            chezmoi-test-debian:latest \
            bash -c 'set -e
              echo "üì¶ Copying dotfiles repository..."
              cp -r /dotfiles-src /tmp/dotfiles
              echo "üîß Pre-configuring chezmoi..."
              mkdir -p ~/.config/chezmoi
              echo "[data.git]" > ~/.config/chezmoi/chezmoi.toml
              echo "  email = \"test@example.com\"" >> ~/.config/chezmoi/chezmoi.toml
              echo "  name = \"Test User\"" >> ~/.config/chezmoi/chezmoi.toml
              echo "[data.packages]" >> ~/.config/chezmoi/chezmoi.toml
              echo "  runInstalls = false" >> ~/.config/chezmoi/chezmoi.toml
              echo "üîß Initializing chezmoi..."
              chezmoi init --source=/tmp/dotfiles --apply --force
              echo "üìã Checking chezmoi status..."
              chezmoi --source=/tmp/dotfiles status || true
              echo "üîç Verifying package list was generated..."
              test -f ~/.config/packages-apt.txt || { echo "‚ùå packages-apt.txt not found"; exit 1; }
              echo "‚úÖ Chezmoi initialization successful!"
              line_count=$(grep -v "^#" ~/.config/packages-apt.txt | grep -v "^$" | wc -l)
              echo "üì¶ Found $line_count packages in APT list"
              if [ "$line_count" -lt 5 ]; then echo "‚ùå Expected more packages in list"; exit 1; fi
              echo "üîç Verifying generated shell config files..."
              for f in \
                ~/.config/fish/functions/is-darwin.fish \
                ~/.config/fish/functions/is-linux.fish \
                ~/.config/fish/conf.d/00-path.fish \
                ~/.config/zsh/.zfunctions/is-darwin \
                ~/.config/zsh/.zfunctions/is-linux \
                ~/.config/zsh/.zshrc.d/00-path.zsh; do
                test -f "$f" || { echo "‚ùå Missing generated file: $f"; exit 1; }
              done
              echo "‚úÖ All checks passed!"'

  test-macos:
    runs-on: macos-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate Brewfile with Homebrew
        run: |
          brew bundle check --file=dot_config/Brewfile_darwin || {
            echo "‚ö†Ô∏è  Some packages not installed (expected on CI)"
            exit 0
          }
